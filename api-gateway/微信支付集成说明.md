# 微信小程序微信支付集成说明

## 概述

本项目已集成微信小程序微信支付功能，提供完整的支付流程API接口。

## 配置说明

### 1. 修改配置文件

编辑 `wechat_pay_config.py` 文件，替换以下配置：

```python
# 微信支付商户号 (请替换为您的实际商户号)
MCH_ID = "1900000109"

# 小程序APPID (请替换为您的实际APPID)
APPID = "wx1234567890abcdef"

# 微信支付API密钥 (请替换为您的实际密钥)
API_KEY = "your_wechat_pay_api_key_here_32_chars"

# 支付回调通知URL
NOTIFY_URL = "https://your-domain.com/api/wechat/pay/notify"
```

### 2. 证书配置

将微信支付证书文件放置在 `certs/` 目录下：
- `apiclient_cert.pem` - 商户证书
- `apiclient_key.pem` - 商户私钥

## API接口说明

### 1. 创建支付订单

**接口地址：** `POST /api/wechat/pay/create`

**请求参数：**
```json
{
    "openid": "用户openid",
    "total_fee": 100,  // 金额，单位：分
    "body": "商品描述",
    "attach": "附加数据（可选）"
}
```

**响应示例：**
```json
{
    "success": true,
    "data": {
        "out_trade_no": "PAY17031234567890123456",
        "pay_params": {
            "appId": "wx1234567890abcdef",
            "timeStamp": "1703123456",
            "nonceStr": "randomstring",
            "package": "prepay_id=wx1234567890abcdef",
            "signType": "MD5",
            "paySign": "signature"
        }
    }
}
```

### 2. 支付回调通知

**接口地址：** `POST /api/wechat/pay/notify`

此接口由微信支付系统调用，无需手动调用。

### 3. 查询支付状态

**接口地址：** `GET /api/wechat/pay/query/{out_trade_no}`

**响应示例：**
```json
{
    "success": true,
    "data": {
        "out_trade_no": "PAY17031234567890123456",
        "transaction_id": "wx1234567890abcdef",
        "trade_state": "SUCCESS",
        "total_fee": "100",
        "time_end": "20231221123456"
    }
}
```

### 4. 获取用户订单列表

**接口地址：** `GET /api/wechat/pay/orders/{openid}`

**响应示例：**
```json
{
    "success": true,
    "data": [
        {
            "out_trade_no": "PAY17031234567890123456",
            "total_fee": 100,
            "body": "商品描述",
            "status": "PAID",
            "create_time": "2023-12-21T12:34:56",
            "time_end": "20231221123456"
        }
    ]
}
```

### 5. 获取支付统计

**接口地址：** `GET /api/wechat/pay/stats`

**响应示例：**
```json
{
    "success": true,
    "data": {
        "total": 100,
        "pending": 10,
        "paid": 80,
        "cancelled": 5,
        "failed": 3,
        "refunded": 2
    }
}
```

## 小程序端调用示例

### 1. 创建支付订单

```javascript
// 调用后端API创建订单
wx.request({
    url: 'https://your-domain.com/api/wechat/pay/create',
    method: 'POST',
    data: {
        openid: 'user_openid',
        total_fee: 100,  // 1元
        body: '图片增强服务',
        attach: 'user_id_123'
    },
    success: function(res) {
        if (res.data.success) {
            // 调用微信支付
            wx.requestPayment({
                timeStamp: res.data.data.pay_params.timeStamp,
                nonceStr: res.data.data.pay_params.nonceStr,
                package: res.data.data.pay_params.package,
                signType: res.data.data.pay_params.signType,
                paySign: res.data.data.pay_params.paySign,
                success: function() {
                    console.log('支付成功');
                    // 支付成功后的处理逻辑
                },
                fail: function(res) {
                    console.log('支付失败', res);
                }
            });
        }
    }
});
```

### 2. 查询支付状态

```javascript
wx.request({
    url: 'https://your-domain.com/api/wechat/pay/query/PAY17031234567890123456',
    method: 'GET',
    success: function(res) {
        if (res.data.success) {
            console.log('订单状态:', res.data.data.trade_state);
        }
    }
});
```

## 订单状态说明

- `PENDING`: 待支付
- `PAID`: 已支付
- `CANCELLED`: 已取消
- `REFUNDED`: 已退款
- `FAILED`: 支付失败

## 安全注意事项

1. **API密钥安全**: 确保API密钥安全存储，不要泄露
2. **签名验证**: 所有回调都会进行签名验证
3. **HTTPS**: 生产环境必须使用HTTPS
4. **金额验证**: 服务端会验证金额范围（1分-10000元）
5. **订单去重**: 系统会自动生成唯一的商户订单号

## 部署说明

1. 确保所有依赖已安装：
   ```bash
   pip install flask flask-cors requests
   ```

2. 启动服务：
   ```bash
   python app.py
   ```

3. 服务将在端口5000启动，微信支付相关接口会自动集成

## 测试建议

1. 使用微信支付沙箱环境进行测试
2. 测试各种支付场景（成功、失败、取消）
3. 验证回调通知的签名验证
4. 测试订单查询功能

## 故障排除

1. **签名验证失败**: 检查API密钥是否正确
2. **订单创建失败**: 检查商户号和APPID配置
3. **回调处理失败**: 检查回调URL是否可访问
4. **证书问题**: 确保证书文件路径正确且格式正确
